#!/bin/sh

echo "LD Wrapping $@"

case $VLC_PLATFORM in
	Windows|Metrox86)
		FORCED_LIBS="user32.lib kernel32.lib Advapi32.lib Ole32.lib RuntimeObject.lib -NODEFAULTLIB:ole32.lib -NODEFAULTLIB:kernel32.lib -NODEFAULTLIB:ws2_32.lib"
		;;
	WindowsPhone)
		FORCED_LIBS="-APPCONTAINER WindowsPhoneCore.lib RuntimeObject.lib PhoneAppModelHost.lib -NODEFAULTLIB:ole32.lib -NODEFAULTLIB:kernel32.lib -NODEFAULTLIB:ws2_32.lib"
		;;
	*)
		echo "clwrap: Invalid platform: $VLC_PLATFORM"
		exit 1
esac

while [ $# -gt 0 ]; do
	case $1 in
	-o)
		LINK_TARGET=`cygpath -w $2`
		shift
		;;
	*.o)
		if [ -f $1 ]; then
			OBJS="$OBJS `cygpath -w $1`"
		else
			# Manually fix the extension if the object file doesn't exist
			OBJS="$OBJS `cygpath -w $1`"bj
		fi
		
		;;
	*.obj)
		OBJS="$OBJS `cygpath -w $1`"
		;;
	-l*)
		OBJS="$OBJS ${1#-l}.lib"
		;;
	-L*)
		libpath=${1#-L}
		if [ "$libpath" != "/mingw32/lib" ]; then
			LIBDIR="$LIBDIR -LIBPATH:`cygpath -w $libpath`"
		fi
		;;
	-*)
		ARGS="$ARGS $1"
		;;
	*)
		echo "Ignoring AR flag: $1"
		;;
	esac
	shift
done

if [ "$LINK_TARGET" = "" ]; then
	echo "Failed to extract target"
	exit 1
fi

echo "Args: $ARGS"
echo "Objs: $OBJS"

#MSVCRTDIR="-LIBPATH:`cygpath -w '/c/Program Files (x86)/Microsoft Visual Studio 11.0/VC/WPSDK/WP80/lib/arm'`"
#echo link -nologo -OPT:REF -OUT:$LINK_TARGET $ARGS $OBJS $LIBDIR $FORCED_LIBS
link -nologo -OPT:REF -OUT:$LINK_TARGET $ARGS $OBJS $LIBDIR $FORCED_LIBS # -NODEFAULTLIB:msvcrt msvcrt.lib $MSVCRTDIR
exit $?

