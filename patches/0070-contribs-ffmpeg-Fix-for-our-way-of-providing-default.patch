From 268a58c89b753e1a508f124f289b8621da333f38 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Hugo=20Beauz=C3=A9e-Luyssen?= <hugo@beauzee.fr>
Date: Fri, 9 Jan 2015 16:51:11 +0100
Subject: [PATCH 070/128] contribs: ffmpeg: Fix for our way of providing
 default LDFLAGS

---
 contrib/src/ffmpeg/msvc.patch | 24 ++++++++++++++++++++++++
 contrib/src/ffmpeg/rules.mak  |  3 +++
 2 files changed, 27 insertions(+)
 create mode 100644 contrib/src/ffmpeg/msvc.patch

diff --git a/contrib/src/ffmpeg/msvc.patch b/contrib/src/ffmpeg/msvc.patch
new file mode 100644
index 0000000..7a9bac2
--- /dev/null
+++ b/contrib/src/ffmpeg/msvc.patch
@@ -0,0 +1,24 @@
+diff --git a/configure b/configure
+index b10715f..3d26996 100755
+--- a/configure
++++ b/configure
+@@ -2821,7 +2821,7 @@
+             -lavifil32)           echo vfw32.lib ;;
+             -lavicap32)           echo vfw32.lib user32.lib ;;
+             -l*)                  echo ${flag#-l}.lib ;;
+-            -L*)                  echo -libpath:${flag#-L} ;;
++            -L*)                  echo -libpath:`cygpath -w ${flag#-L}` ;;
+             *)                    echo $flag ;;
+         esac
+     done
+@@ -3154,6 +3154,10 @@
+ add_host_ldflags $_flags $_ldflags
+ HOSTLD_O=${_ld_o-$HOSTLD_O}
+ 
++_ldflags=$LDFLAGS
++LDFLAGS=
++add_ldflags $_ldflags
++
+ if [ -z "$CC_DEPFLAGS" ] && [ "$dep_cc" != "$cc" ]; then
+     probe_cc depcc "$dep_cc"
+     CCDEP=${_DEPCMD:-$DEPCMD}
diff --git a/contrib/src/ffmpeg/rules.mak b/contrib/src/ffmpeg/rules.mak
index 485b5b6..14b99f6 100644
--- a/contrib/src/ffmpeg/rules.mak
+++ b/contrib/src/ffmpeg/rules.mak
@@ -181,6 +181,9 @@ ffmpeg: ffmpeg-$(HASH).tar.xz .sum-ffmpeg
 	rm -Rf $@ $@-$(HASH)
 	mkdir -p $@-$(HASH)
 	$(XZCAT) "$<" | (cd $@-$(HASH) && tar xv --strip-components=1)
+ifdef HAVE_VISUALSTUDIO
+	$(APPLY) $(SRC)/ffmpeg/msvc.patch
+endif
 	$(MOVE)
 
 .ffmpeg: ffmpeg
-- 
1.9.5.msysgit.1

