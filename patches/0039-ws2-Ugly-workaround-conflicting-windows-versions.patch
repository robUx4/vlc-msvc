From c6d282dde35d6ac014f91b2fea86b7860135f7f4 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Hugo=20Beauz=C3=A9e-Luyssen?= <hugo@beauzee.fr>
Date: Thu, 20 Nov 2014 15:16:22 +0100
Subject: [PATCH 39/82] ws2: Ugly workaround conflicting windows versions

---
 compat/gettimeofday.c       |  3 +--
 compat/inet_pton.c          |  2 +-
 compat/poll.c               |  2 +-
 include/vlc_common.h        |  2 +-
 include/vlc_network.h       |  4 ++--
 include/vlc_winsock2.h      | 50 +++++++++++++++++++++++++++++++++++++++++++++
 include/vlc_ws2tcpip.h      | 50 +++++++++++++++++++++++++++++++++++++++++++++
 modules/access/live555.cpp  |  2 +-
 modules/access/rtp/srtp.c   |  2 +-
 modules/access_output/udp.c |  4 ++--
 src/Makefile.am             |  2 ++
 src/misc/objects.c          |  4 ++--
 src/network/httpd.c         |  2 +-
 src/win32/filesystem.c      |  2 +-
 14 files changed, 116 insertions(+), 15 deletions(-)
 create mode 100644 include/vlc_winsock2.h
 create mode 100644 include/vlc_ws2tcpip.h

diff --git a/compat/gettimeofday.c b/compat/gettimeofday.c
index 408784c..3ade0c1 100644
--- a/compat/gettimeofday.c
+++ b/compat/gettimeofday.c
@@ -25,9 +25,8 @@
 #ifdef _MSC_VER
 
 /* Taken from postgresql */
-
 #include <sys/time.h>
-#include <Winsock2.h>
+#include <vlc_winsock2.h>
 
 /* FILETIME of Jan 1 1970 00:00:00. */
 static const unsigned __int64 epoch = 116444736000000000;
diff --git a/compat/inet_pton.c b/compat/inet_pton.c
index fb825c2..415423a 100644
--- a/compat/inet_pton.c
+++ b/compat/inet_pton.c
@@ -29,7 +29,7 @@
 #ifndef _WIN32
 # include <sys/socket.h>
 #else
-# include <winsock2.h>
+# include <vlc_winsock2.h>
 # undef EAFNOSUPPORT
 # define EAFNOSUPPORT WSAEAFNOSUPPORT
 #endif
diff --git a/compat/poll.c b/compat/poll.c
index b88f7fd..ebfe08b 100644
--- a/compat/poll.c
+++ b/compat/poll.c
@@ -32,7 +32,7 @@
 #  error Header inclusion order compromised!
 # endif
 # define FD_SETSIZE 0
-# include <winsock2.h>
+# include <vlc_winsock2.h>
 #else
 # include <sys/time.h>
 # include <sys/select.h>
diff --git a/include/vlc_common.h b/include/vlc_common.h
index 61ea81e..27f0ac9 100644
--- a/include/vlc_common.h
+++ b/include/vlc_common.h
@@ -400,7 +400,7 @@ typedef enum
 #   endif
 #   include <windows.h>
 #   ifdef _MSC_VER
-#    include <winsock2.h>
+#    include <vlc_winsock2.h>
 #   endif
 #endif
 
diff --git a/include/vlc_network.h b/include/vlc_network.h
index 70281a2..effb324 100644
--- a/include/vlc_network.h
+++ b/include/vlc_network.h
@@ -35,8 +35,8 @@
 #if defined( _WIN32 )
 #   define _NO_OLDNAMES 1
 #   include <io.h>
-#   include <winsock2.h>
-#   include <ws2tcpip.h>
+#   include <vlc_winsock2.h>
+#   include <vlc_ws2tcpip.h>
 #   define net_errno (WSAGetLastError())
 
 struct iovec
diff --git a/include/vlc_winsock2.h b/include/vlc_winsock2.h
new file mode 100644
index 0000000..eb1f9f6
--- /dev/null
+++ b/include/vlc_winsock2.h
@@ -0,0 +1,50 @@
+/*****************************************************************************
+ * vlc_winsock2.c
+ *****************************************************************************
+ * Copyright © 2014 VLC authors and VideoLAN
+ *
+ * This program is free software; you can redistribute it and/or modify it
+ * under the terms of the GNU Lesser General Public License as published by
+ * the Free Software Foundation; either version 2.1 of the License, or
+ * (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+ * GNU Lesser General Public License for more details.
+ *
+ * You should have received a copy of the GNU Lesser General Public License
+ * along with this program; if not, write to the Free Software Foundation,
+ * Inc., 51 Franklin Street, Fifth Floor, Boston MA 02110-1301, USA.
+ *****************************************************************************/
+ 
+#ifndef VLC_WINSOCK2_H
+# define VLC_WINSOCK2_H
+
+#ifndef _WIN32_WINNT
+# error _WIN32_WINNT should have been defined
+#endif
+
+#pragma push_macro("_WIN32_WINNT")
+#undef _WIN32_WINNT
+#define _WIN32_WINNT 0x0502
+
+#ifdef WINAPI_FAMILY
+# pragma push_macro("WINAPI_FAMILY")
+# define POP_WINAPI_FAMILY
+# undef WINAPI_FAMILY
+#endif
+
+#define WINAPI_FAMILY WINAPI_FAMILY_DESKTOP_APP
+
+#include <Winsock2.h>
+
+#ifdef POP_WINAPI_FAMILY
+# pragma pop_macro("WINAPI_FAMILY")
+#else
+# undef WINAPI_FAMILY
+#endif
+
+#pragma pop_macro("_WIN32_WINNT")
+
+#endif
\ No newline at end of file
diff --git a/include/vlc_ws2tcpip.h b/include/vlc_ws2tcpip.h
new file mode 100644
index 0000000..c06c9c2
--- /dev/null
+++ b/include/vlc_ws2tcpip.h
@@ -0,0 +1,50 @@
+/*****************************************************************************
+ * vlc_ws2tcpip.h
+ *****************************************************************************
+ * Copyright © 2014 VLC authors and VideoLAN
+ *
+ * This program is free software; you can redistribute it and/or modify it
+ * under the terms of the GNU Lesser General Public License as published by
+ * the Free Software Foundation; either version 2.1 of the License, or
+ * (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+ * GNU Lesser General Public License for more details.
+ *
+ * You should have received a copy of the GNU Lesser General Public License
+ * along with this program; if not, write to the Free Software Foundation,
+ * Inc., 51 Franklin Street, Fifth Floor, Boston MA 02110-1301, USA.
+ *****************************************************************************/
+ 
+#ifndef VLC_WS2TCPIP_H
+# define VLC_WS2TCPIP_H
+
+#ifndef _WIN32_WINNT
+# error _WIN32_WINNT should have been defined
+#endif
+
+#pragma push_macro("_WIN32_WINNT")
+#undef _WIN32_WINNT
+#define _WIN32_WINNT 0x0502
+
+#ifdef WINAPI_FAMILY
+# pragma push_macro("WINAPI_FAMILY")
+# define POP_WINAPI_FAMILY
+# undef WINAPI_FAMILY
+#endif
+
+#define WINAPI_FAMILY WINAPI_FAMILY_DESKTOP_APP
+
+#include <ws2tcpip.h>
+
+#ifdef POP_WINAPI_FAMILY
+# pragma pop_macro("WINAPI_FAMILY")
+#else
+# undef WINAPI_FAMILY
+#endif
+
+#pragma pop_macro("_WIN32_WINNT")
+
+#endif
\ No newline at end of file
diff --git a/modules/access/live555.cpp b/modules/access/live555.cpp
index a6f65c9..f027b11 100644
--- a/modules/access/live555.cpp
+++ b/modules/access/live555.cpp
@@ -53,7 +53,7 @@
 
 
 #if defined( _WIN32 )
-#   include <winsock2.h>
+#   include <vlc_winsock2.h>
 #endif
 
 #include <UsageEnvironment.hh>
diff --git a/modules/access/rtp/srtp.c b/modules/access/rtp/srtp.c
index 883e553..d11ae3f 100644
--- a/modules/access/rtp/srtp.c
+++ b/modules/access/rtp/srtp.c
@@ -40,7 +40,7 @@
 #include <gcrypt.h>
 
 #ifdef _WIN32
-# include <winsock2.h>
+# include <vlc_winsock2.h>
 #else
 # include <netinet/in.h>
 #endif
diff --git a/modules/access_output/udp.c b/modules/access_output/udp.c
index 2ce33a5..f975a4a 100644
--- a/modules/access_output/udp.c
+++ b/modules/access_output/udp.c
@@ -41,8 +41,8 @@
 #include <vlc_block.h>
 
 #ifdef _WIN32
-#   include <winsock2.h>
-#   include <ws2tcpip.h>
+#   include <vlc_winsock2.h>
+#   include <vlc_ws2tcpip.h>
 #else
 #   include <sys/socket.h>
 #endif
diff --git a/src/Makefile.am b/src/Makefile.am
index e200669..c4c7fca 100644
--- a/src/Makefile.am
+++ b/src/Makefile.am
@@ -96,6 +96,8 @@ pluginsinclude_HEADERS = \
 	../include/vlc_vout_window.h \
 	../include/vlc_xml.h \
 	../include/vlc_xlib.h \
+    ../include/vlc_winsock2.h \
+    ../include/vlc_ws2tcpip.h \
 	$(NULL)
 nodist_pluginsinclude_HEADERS = ../include/vlc_about.h
 
diff --git a/src/misc/objects.c b/src/misc/objects.c
index 3b04518..707b30d 100644
--- a/src/misc/objects.c
+++ b/src/misc/objects.c
@@ -58,8 +58,8 @@
 # include <unistd.h>    // close(), write()
 #elif defined(_WIN32)
 # include <io.h>
-# include <winsock2.h>
-# include <ws2tcpip.h>
+# include <vlc_winsock2.h>
+# include <vlc_ws2tcpip.h>
 # undef  read
 # define read( a, b, c )  recv (a, b, c, 0)
 # undef  write
diff --git a/src/network/httpd.c b/src/network/httpd.c
index 9b4f3ad..d5fdc4d 100644
--- a/src/network/httpd.c
+++ b/src/network/httpd.c
@@ -51,7 +51,7 @@
 #endif
 
 #if defined(_WIN32)
-#   include <winsock2.h>
+#   include <vlc_winsock2.h>
 #else
 #   include <sys/socket.h>
 #endif
diff --git a/src/win32/filesystem.c b/src/win32/filesystem.c
index f938147..131b3d0 100644
--- a/src/win32/filesystem.c
+++ b/src/win32/filesystem.c
@@ -36,7 +36,7 @@
 #include <dirent.h>
 #include <sys/stat.h>
 #include <fcntl.h>
-#include <winsock2.h>
+#include <vlc_winsock2.h>
 #include <direct.h>
 
 #include <vlc_common.h>
-- 
2.2.0

