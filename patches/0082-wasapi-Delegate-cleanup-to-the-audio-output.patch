From 1cbf3197fa29e3832ba8ab55095ef3ca71dc99a4 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Hugo=20Beauz=C3=A9e-Luyssen?= <hugo@beauzee.fr>
Date: Mon, 16 Feb 2015 11:44:13 +0100
Subject: [PATCH 82/82] wasapi: Delegate cleanup to the audio output

---
 modules/audio_output/mmdevice.c | 9 +++++++++
 modules/audio_output/mmdevice.h | 8 ++++++++
 modules/audio_output/wasapi.c   | 5 ++---
 modules/audio_output/winstore.c | 7 +++++++
 4 files changed, 26 insertions(+), 3 deletions(-)

diff --git a/modules/audio_output/mmdevice.c b/modules/audio_output/mmdevice.c
index 2803704..e95757a 100644
--- a/modules/audio_output/mmdevice.c
+++ b/modules/audio_output/mmdevice.c
@@ -1059,6 +1059,13 @@ static HRESULT ActivateDevice(void *opaque, REFIID iid, PROPVARIANT *actparms,
     return IMMDevice_Activate(dev, iid, CLSCTX_ALL, actparms, pv);
 }
 
+static void DeactivateDevice(void* pv)
+{
+    IAudioClient *device = (IAudioClient*)pv;
+    IAudioClient_Stop(device); /* should not be needed */
+    IAudioClient_Release(device);
+}
+
 static int aout_stream_Start(void *func, va_list ap)
 {
     aout_stream_start_t start = func;
@@ -1093,6 +1100,7 @@ static int Start(audio_output_t *aout, audio_sample_format_t *restrict fmt)
 
     s->owner.device = sys->dev;
     s->owner.activate = ActivateDevice;
+    s->owner.deactivate = DeactivateDevice;
 
     EnterMTA();
     for (;;)
@@ -1131,6 +1139,7 @@ static void Stop(audio_output_t *aout)
 
     vlc_object_release(sys->stream);
     sys->stream = NULL;
+    IAudioClient_Release(sys->client);
 }
 
 static int Open(vlc_object_t *obj)
diff --git a/modules/audio_output/mmdevice.h b/modules/audio_output/mmdevice.h
index 51f5e42..bec4597 100644
--- a/modules/audio_output/mmdevice.h
+++ b/modules/audio_output/mmdevice.h
@@ -40,6 +40,7 @@ struct aout_stream
     {
         void *device;
         HRESULT (*activate)(void *device, REFIID, PROPVARIANT *, void **);
+        void(*deactivate)(void*);
     } owner;
 };
 
@@ -92,4 +93,11 @@ HRESULT aout_stream_Activate(aout_stream_t *s, REFIID iid,
 {
     return s->owner.activate(s->owner.device, iid, actparms, pv);
 }
+
+static inline
+void aout_stream_Deactivate(aout_stream_t *s, void *dev)
+{
+    if (s->owner.deactivate != NULL)
+        s->owner.deactivate(dev);
+}
 #endif
diff --git a/modules/audio_output/wasapi.c b/modules/audio_output/wasapi.c
index 911eab1..ff8b0bf 100644
--- a/modules/audio_output/wasapi.c
+++ b/modules/audio_output/wasapi.c
@@ -447,7 +447,7 @@ static HRESULT Start(aout_stream_t *s, audio_sample_format_t *restrict fmt,
     return S_OK;
 error:
     if (sys->client != NULL)
-        IAudioClient_Release(sys->client);
+        aout_stream_Deactivate(s, sys->client);
     free(sys);
     return hr;
 }
@@ -456,8 +456,7 @@ static void Stop(aout_stream_t *s)
 {
     aout_stream_sys_t *sys = s->sys;
 
-    IAudioClient_Stop(sys->client); /* should not be needed */
-    IAudioClient_Release(sys->client);
+    aout_stream_Deactivate(s, sys->client);
 
     free(sys);
 }
diff --git a/modules/audio_output/winstore.c b/modules/audio_output/winstore.c
index 988cada..004a25f 100644
--- a/modules/audio_output/winstore.c
+++ b/modules/audio_output/winstore.c
@@ -109,6 +109,12 @@ static HRESULT ActivateDevice(void *opaque, REFIID iid, PROPVARIANT *actparms,
     return S_OK;
 }
 
+static void DeactivateDevice(void* device)
+{
+    IAudioClient_Stop((IAudioClient*)device);
+    IAudioClient_Release((IAudioClient*) device);
+}
+
 static int aout_stream_Start(void *func, va_list ap)
 {
     aout_stream_start_t start = func;
@@ -139,6 +145,7 @@ static int Start(audio_output_t *aout, audio_sample_format_t *restrict fmt)
 
     s->owner.device = sys->client;
     s->owner.activate = ActivateDevice;
+    s->owner.deactivate = DeactivateDevice;
 
     EnterMTA();
     sys->module = vlc_module_load(s, "aout stream", NULL, false,
-- 
2.2.0

