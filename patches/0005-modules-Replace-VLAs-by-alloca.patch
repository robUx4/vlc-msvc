From 5084071088e6800f79201524f18dc7408b63d40d Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Hugo=20Beauz=C3=A9e-Luyssen?= <hugo@beauzee.fr>
Date: Tue, 21 Oct 2014 14:46:08 +0200
Subject: [PATCH 05/76] modules: Replace VLAs by alloca()

---
 modules/access/ftp.c                  | 2 +-
 modules/access/vcd/cdrom.c            | 2 +-
 modules/codec/avcodec/audio.c         | 4 ++--
 modules/codec/libass.c                | 4 ++--
 modules/control/globalhotkeys/win32.c | 2 +-
 modules/control/rc.c                  | 2 +-
 modules/demux/avformat/demux.c        | 2 +-
 modules/demux/avi/avi.c               | 4 ++--
 modules/demux/playlist/dvb.c          | 2 +-
 modules/lua/libs/net.c                | 2 +-
 modules/misc/addons/fsstorage.c       | 2 +-
 modules/services_discovery/sap.c      | 4 ++--
 modules/video_output/vmem.c           | 2 +-
 13 files changed, 17 insertions(+), 17 deletions(-)

diff --git a/modules/access/ftp.c b/modules/access/ftp.c
index 5224e7e..d7d8fcf 100644
--- a/modules/access/ftp.c
+++ b/modules/access/ftp.c
@@ -151,7 +151,7 @@ static int ftp_SendCommand( vlc_object_t *obj, access_sys_t *sys,
                             const char *fmt, ... )
 {
     size_t fmtlen = strlen( fmt );
-    char fmtbuf[fmtlen + 3];
+    char *fmtbuf = alloca(fmtlen + 3);
 
     memcpy( fmtbuf, fmt, fmtlen );
     memcpy( fmtbuf + fmtlen, "\r\n", 3 );
diff --git a/modules/access/vcd/cdrom.c b/modules/access/vcd/cdrom.c
index a4a8bd4..7ce9ad4 100644
--- a/modules/access/vcd/cdrom.c
+++ b/modules/access/vcd/cdrom.c
@@ -1282,7 +1282,7 @@ static int CdTextRead( vlc_object_t *p_object, const vcddev_t *p_vcddev,
     TOCEx.Format = CDROM_READ_TOC_EX_FORMAT_CDTEXT;
 
     const int i_header_size = __MAX( 4, MINIMUM_CDROM_READ_TOC_EX_SIZE );
-    uint8_t header[i_header_size];
+    uint8_t *header = alloca(i_header_size);
     DWORD i_read;
     if( !DeviceIoControl( p_vcddev->h_device_handle, IOCTL_CDROM_READ_TOC_EX,
                           &TOCEx, sizeof(TOCEx), header, i_header_size, &i_read, 0 ) )
diff --git a/modules/codec/avcodec/audio.c b/modules/codec/avcodec/audio.c
index a37f1cf..4d6dde4 100644
--- a/modules/codec/avcodec/audio.c
+++ b/modules/codec/avcodec/audio.c
@@ -408,7 +408,7 @@ static block_t *DecodeAudio( decoder_t *p_dec, block_t **pp_block )
         if (unlikely(p_block == NULL))
             goto drop;
 
-        const void *planes[ctx->channels];
+        const void **planes = alloca(ctx->channels * sizeof(*planes));
         for (int i = 0; i < ctx->channels; i++)
             planes[i] = frame->extended_data[i];
 
@@ -550,7 +550,7 @@ static void SetupOutputFormat( decoder_t *p_dec, bool b_trust )
      * FIXME should we use fmt_in.audio.i_physical_channels or not ?
      */
     const unsigned i_order_max = 8 * sizeof(p_sys->p_context->channel_layout);
-    uint32_t pi_order_src[i_order_max];
+    uint32_t *pi_order_src = alloca(i_order_max * sizeof(*pi_order_src));
     int i_channels_src = 0;
 
     if( p_sys->p_context->channel_layout )
diff --git a/modules/codec/libass.c b/modules/codec/libass.c
index f6f14a6..a7680cd 100644
--- a/modules/codec/libass.c
+++ b/modules/codec/libass.c
@@ -448,7 +448,7 @@ static void SubpictureUpdate( subpicture_t *p_subpic,
      * it looks ugly (text unaligned).
      */
     const int i_max_region = 4;
-    rectangle_t region[i_max_region];
+    rectangle_t *region = alloca(i_max_region * sizeof(*region));
     const int i_region = BuildRegions( region, i_max_region, p_img, fmt.i_width, fmt.i_height );
 
     if( i_region <= 0 )
@@ -553,7 +553,7 @@ static int BuildRegions( rectangle_t *p_region, int i_max_region, ASS_Image *p_i
     int i_maxh = i_w_inc;
     int i_maxw = i_h_inc;
     int i_region;
-    rectangle_t region[i_max_region+1];
+    rectangle_t *region = alloca((i_max_region+1) * sizeof(*region));
 
     i_region = 0;
     for( int i_used = 0; i_used < i_count; )
diff --git a/modules/control/globalhotkeys/win32.c b/modules/control/globalhotkeys/win32.c
index f80510e..e21d014 100644
--- a/modules/control/globalhotkeys/win32.c
+++ b/modules/control/globalhotkeys/win32.c
@@ -170,7 +170,7 @@ static void *Thread( void *p_data )
             p_hotkey->psz_action != NULL;
             p_hotkey++ )
     {
-        char varname[12 + strlen( p_hotkey->psz_action )];
+        char *varname = alloca(12 + strlen( p_hotkey->psz_action ));
         sprintf( varname, "global-key-%s", p_hotkey->psz_action );
 
         char *key = var_InheritString( p_intf, varname );
diff --git a/modules/control/rc.c b/modules/control/rc.c
index 12635ad..fae89df 100644
--- a/modules/control/rc.c
+++ b/modules/control/rc.c
@@ -140,7 +140,7 @@ VLC_FORMAT(2, 3)
 static void msg_rc( intf_thread_t *p_intf, const char *psz_fmt, ... )
 {
     va_list args;
-    char fmt_eol[strlen (psz_fmt) + 3];
+    char *fmt_eol = alloca(strlen (psz_fmt) + 3);
 
     snprintf (fmt_eol, sizeof (fmt_eol), "%s\r\n", psz_fmt);
     va_start( args, psz_fmt );
diff --git a/modules/demux/avformat/demux.c b/modules/demux/avformat/demux.c
index d6a271c..7ce3407 100644
--- a/modules/demux/avformat/demux.c
+++ b/modules/demux/avformat/demux.c
@@ -288,7 +288,7 @@ int OpenDemux( vlc_object_t *p_this )
 
 #if LIBAVFORMAT_VERSION_INT >= ((53<<16)+(26<<8)+0)
     char *psz_opts = var_InheritString( p_demux, "avformat-options" );
-    AVDictionary *options[p_sys->ic->nb_streams ? p_sys->ic->nb_streams : 1];
+    AVDictionary **options = alloca((p_sys->ic->nb_streams ? p_sys->ic->nb_streams : 1) * sizeof(*options));
     options[0] = NULL;
     unsigned int nb_streams = p_sys->ic->nb_streams;
     for (unsigned i = 1; i < nb_streams; i++)
diff --git a/modules/demux/avi/avi.c b/modules/demux/avi/avi.c
index 10ea01d..3e378d6 100644
--- a/modules/demux/avi/avi.c
+++ b/modules/demux/avi/avi.c
@@ -2477,8 +2477,8 @@ static void AVI_IndexLoad( demux_t *p_demux )
 
     /* Load indexes */
     assert( p_sys->i_track <= 100 );
-    avi_index_t p_idx_indx[p_sys->i_track];
-    avi_index_t p_idx_idx1[p_sys->i_track];
+    avi_index_t *p_idx_indx = alloca(p_sys->i_track * sizeof(*p_idx_indx));
+    avi_index_t *p_idx_idx1 = alloca(p_sys->i_track * sizeof(*p_idx_idx1));
     for( unsigned i = 0; i < p_sys->i_track; i++ )
     {
         avi_index_Init( &p_idx_indx[i] );
diff --git a/modules/demux/playlist/dvb.c b/modules/demux/playlist/dvb.c
index 0b5e796..4c7ff1a 100644
--- a/modules/demux/playlist/dvb.c
+++ b/modules/demux/playlist/dvb.c
@@ -60,7 +60,7 @@ int Import_DVB(vlc_object_t *obj)
         return VLC_EGENERIC;
     len = eol - peek;
 
-    char line[len + 1];
+    char *line = alloca(len + 1);
     memcpy(line, peek, len);
     line[len] = '\0';
 
diff --git a/modules/lua/libs/net.c b/modules/lua/libs/net.c
index 4d6e87b..271ad91 100644
--- a/modules/lua/libs/net.c
+++ b/modules/lua/libs/net.c
@@ -302,7 +302,7 @@ static int vlclua_net_recv( lua_State *L )
 {
     int fd = vlclua_fd_get( L, luaL_checkint( L, 1 ) );
     size_t i_len = luaL_optint( L, 2, 1 );
-    char psz_buffer[i_len];
+    char *psz_buffer = alloca(i_len);
 
     ssize_t i_ret = (fd != -1) ? recv( fd, psz_buffer, i_len, 0 ) : -1;
     if( i_ret > 0 )
diff --git a/modules/misc/addons/fsstorage.c b/modules/misc/addons/fsstorage.c
index 717050c..057ff50 100644
--- a/modules/misc/addons/fsstorage.c
+++ b/modules/misc/addons/fsstorage.c
@@ -354,7 +354,7 @@ static int recursive_mkdir( vlc_object_t *p_this, const char *psz_dirname )
         case ENOENT:
         {
             /* Let's try to create the parent directory */
-            char psz_parent[strlen( psz_dirname ) + 1], *psz_end;
+            char *psz_parent = alloca(strlen( psz_dirname ) + 1), *psz_end;
             strcpy( psz_parent, psz_dirname );
 
             psz_end = strrchr( psz_parent, DIR_SEP_CHAR );
diff --git a/modules/services_discovery/sap.c b/modules/services_discovery/sap.c
index 8888215..a078b36 100644
--- a/modules/services_discovery/sap.c
+++ b/modules/services_discovery/sap.c
@@ -533,7 +533,7 @@ static void *Run( void *data )
     {
         vlc_restorecancel (canc);
         unsigned n = p_sd->p_sys->i_fd;
-        struct pollfd ufd[n];
+        struct pollfd *ufd = alloca(n * sizeof(*ufd));
 
         for (unsigned i = 0; i < n; i++)
         {
@@ -1191,7 +1191,7 @@ static sdp_t *ParseSDP (vlc_object_t *p_obj, const char *psz_sdp)
         /* Extract one line */
         char *eol = strchr (psz_sdp, '\n');
         size_t linelen = eol ? (size_t)(eol - psz_sdp) : strlen (psz_sdp);
-        char line[linelen + 1];
+        char *line = alloca(linelen + 1);
         memcpy (line, psz_sdp, linelen);
         line[linelen] = '\0';
 
diff --git a/modules/video_output/vmem.c b/modules/video_output/vmem.c
index 3f117da..cc2e4b3 100644
--- a/modules/video_output/vmem.c
+++ b/modules/video_output/vmem.c
@@ -282,7 +282,7 @@ static picture_pool_t *Pool(vout_display_t *vd, unsigned count)
     if (count > sys->count)
         count = sys->count;
 
-    picture_t *pictures[count];
+    picture_t **pictures = alloca(count * sizeof(*pictures));
 
     for (unsigned i = 0; i < count; i++) {
         picture_sys_t *picsys = malloc(sizeof (*picsys));
-- 
2.2.0

