From 685e5d5e8c058c85307faf9403bb52628d4e516c Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Hugo=20Beauz=C3=A9e-Luyssen?= <hugo@beauzee.fr>
Date: Wed, 1 Apr 2015 16:20:35 +0200
Subject: [PATCH 71/99] Revert "wasapi: Delegate cleanup to the audio output"

This reverts commit a7fd39be90ca2d9f61574deadd5123ef127dcae9.
---
 modules/audio_output/mmdevice.c | 9 ---------
 modules/audio_output/mmdevice.h | 8 --------
 modules/audio_output/wasapi.c   | 5 +++--
 modules/audio_output/winstore.c | 7 -------
 4 files changed, 3 insertions(+), 26 deletions(-)

diff --git a/modules/audio_output/mmdevice.c b/modules/audio_output/mmdevice.c
index e95757a..2803704 100644
--- a/modules/audio_output/mmdevice.c
+++ b/modules/audio_output/mmdevice.c
@@ -1059,13 +1059,6 @@ static HRESULT ActivateDevice(void *opaque, REFIID iid, PROPVARIANT *actparms,
     return IMMDevice_Activate(dev, iid, CLSCTX_ALL, actparms, pv);
 }
 
-static void DeactivateDevice(void* pv)
-{
-    IAudioClient *device = (IAudioClient*)pv;
-    IAudioClient_Stop(device); /* should not be needed */
-    IAudioClient_Release(device);
-}
-
 static int aout_stream_Start(void *func, va_list ap)
 {
     aout_stream_start_t start = func;
@@ -1100,7 +1093,6 @@ static int Start(audio_output_t *aout, audio_sample_format_t *restrict fmt)
 
     s->owner.device = sys->dev;
     s->owner.activate = ActivateDevice;
-    s->owner.deactivate = DeactivateDevice;
 
     EnterMTA();
     for (;;)
@@ -1139,7 +1131,6 @@ static void Stop(audio_output_t *aout)
 
     vlc_object_release(sys->stream);
     sys->stream = NULL;
-    IAudioClient_Release(sys->client);
 }
 
 static int Open(vlc_object_t *obj)
diff --git a/modules/audio_output/mmdevice.h b/modules/audio_output/mmdevice.h
index bec4597..51f5e42 100644
--- a/modules/audio_output/mmdevice.h
+++ b/modules/audio_output/mmdevice.h
@@ -40,7 +40,6 @@ struct aout_stream
     {
         void *device;
         HRESULT (*activate)(void *device, REFIID, PROPVARIANT *, void **);
-        void(*deactivate)(void*);
     } owner;
 };
 
@@ -93,11 +92,4 @@ HRESULT aout_stream_Activate(aout_stream_t *s, REFIID iid,
 {
     return s->owner.activate(s->owner.device, iid, actparms, pv);
 }
-
-static inline
-void aout_stream_Deactivate(aout_stream_t *s, void *dev)
-{
-    if (s->owner.deactivate != NULL)
-        s->owner.deactivate(dev);
-}
 #endif
diff --git a/modules/audio_output/wasapi.c b/modules/audio_output/wasapi.c
index ff8b0bf..911eab1 100644
--- a/modules/audio_output/wasapi.c
+++ b/modules/audio_output/wasapi.c
@@ -447,7 +447,7 @@ static HRESULT Start(aout_stream_t *s, audio_sample_format_t *restrict fmt,
     return S_OK;
 error:
     if (sys->client != NULL)
-        aout_stream_Deactivate(s, sys->client);
+        IAudioClient_Release(sys->client);
     free(sys);
     return hr;
 }
@@ -456,7 +456,8 @@ static void Stop(aout_stream_t *s)
 {
     aout_stream_sys_t *sys = s->sys;
 
-    aout_stream_Deactivate(s, sys->client);
+    IAudioClient_Stop(sys->client); /* should not be needed */
+    IAudioClient_Release(sys->client);
 
     free(sys);
 }
diff --git a/modules/audio_output/winstore.c b/modules/audio_output/winstore.c
index c41ea60..4734f39 100644
--- a/modules/audio_output/winstore.c
+++ b/modules/audio_output/winstore.c
@@ -114,12 +114,6 @@ static HRESULT ActivateDevice(void *opaque, REFIID iid, PROPVARIANT *actparms,
     return S_OK;
 }
 
-static void DeactivateDevice(void* device)
-{
-    IAudioClient_Stop((IAudioClient*)device);
-    IAudioClient_Release((IAudioClient*) device);
-}
-
 static int aout_stream_Start(void *func, va_list ap)
 {
     aout_stream_start_t start = func;
@@ -150,7 +144,6 @@ static int Start(audio_output_t *aout, audio_sample_format_t *restrict fmt)
 
     s->owner.device = sys->client;
     s->owner.activate = ActivateDevice;
-    s->owner.deactivate = DeactivateDevice;
 
     EnterMTA();
     sys->module = vlc_module_load(s, "aout stream", NULL, false,
-- 
1.9.5.msysgit.1

