From 5723bb4c8708a3e4cb17f00b488f669bf7553dcb Mon Sep 17 00:00:00 2001
From: Steve Lhomme <robUx4@gmail.com>
Date: Tue, 4 Aug 2015 10:34:57 +0200
Subject: [PATCH 093/128] live555: fix Winstore certification

---
 contrib/src/live555/rules.mak      |  8 ++++++--
 contrib/src/live555/winstore.patch | 30 ++++++++++++++++++++++++++++++
 2 files changed, 36 insertions(+), 2 deletions(-)
 create mode 100644 contrib/src/live555/winstore.patch

diff --git a/contrib/src/live555/rules.mak b/contrib/src/live555/rules.mak
index 9d7dfe6..edf8883 100644
--- a/contrib/src/live555/rules.mak
+++ b/contrib/src/live555/rules.mak
@@ -36,6 +36,7 @@ endif
 endif
 
 LIVE_EXTRA_CFLAGS := $(EXTRA_CFLAGS) -fexceptions
+XT_FL := "$(LIVE_EXTRA_CFLAGS)"
 
 live555: $(LIVE555_FILE) .sum-live555
 	rm -Rf live
@@ -46,8 +47,10 @@ live555: $(LIVE555_FILE) .sum-live555
 	cd live && sed -i.orig -e s/"libtool -s -o"/"ar cr"/g config.macosx*
 	cd live && sed -i.orig \
 		-e 's%$(CXX)%$(CXX)\ $(EXTRA_LDFLAGS)%' config.macosx
-	cd live && sed -i.orig \
-		-e 's%^\(COMPILE_OPTS.*\)$$%\1 '"$(LIVE_EXTRA_CFLAGS)%" config.*
+#	echo extra CFLAGS: $(LIVE_EXTRA_CFLAGS)
+#	echo XT_FL: $(XT_FL)
+#	cd live && sed -i.orig \
+#		-e 's%^\(COMPILE_OPTS.*\)$$%\1 '"$(LIVE_EXTRA_CFLAGS)%" config.*
 	cd live && sed -e 's%-D_FILE_OFFSET_BITS=64%-D_FILE_OFFSET_BITS=64\ -fPIC\ -DPIC%' -i.orig config.linux
 	cd live && sed -e 's%-DSOLARIS%-DSOLARIS -DXLOCALE_NOT_USED%' -i.orig config.solaris-*bit
 ifdef HAVE_ANDROID
@@ -56,6 +59,7 @@ endif
 ifdef HAVE_VISUALSTUDIO
 	cd live && patch -lfp1 < ../../src/live555/msvc.patch
 endif
+	cd live && patch -lfp1 < ../../src/live555/winstore.patch
 	mv live $@
 	touch $@
 
diff --git a/contrib/src/live555/winstore.patch b/contrib/src/live555/winstore.patch
new file mode 100644
index 0000000..7723e3b
--- /dev/null
+++ b/contrib/src/live555/winstore.patch
@@ -0,0 +1,30 @@
+--- a/liveMedia/include/InputFile.hh      2015-06-24 16:32:45.000000000 +0200
++++ b/liveMedia/include/InputFile.hh   2015-08-04 10:12:13.791494000 +0200
+@@ -50,6 +50,7 @@
+
+ void CloseInputFile(FILE* fid);
+
++#undef GetFileSize
+ u_int64_t GetFileSize(char const* fileName, FILE* fid);
+     // 0 means zero-length, unbounded, or unknown
+
+
+--- a/BasicUsageEnvironment/BasicUsageEnvironment0.cpp    2015-06-24 16:32:45.000000000 +0200
++++ b/BasicUsageEnvironment/BasicUsageEnvironment0.cpp 2015-08-04 10:22:41.067003200 +0200
+@@ -68,6 +68,7 @@
+
+   if (err == 0) err = getErrno();
+ #if defined(__WIN32__) || defined(_WIN32) || defined(_WIN32_WCE)
++#ifndef _UNICODE
+   char errMsg[RESULT_MSG_BUFFER_MAX] = "\0";
+   if (0 != FormatMessageA(FORMAT_MESSAGE_FROM_SYSTEM, NULL, err, 0, errMsg, sizeof(errMsg)/sizeof(errMsg[0]), NULL)) {
+     // Remove all trailing '\r', '\n' and '.'
+@@ -77,6 +78,7 @@
+   } else
+     snprintf(errMsg, sizeof(errMsg)/sizeof(errMsg[0]), "error %d", err);
+   appendToResultMsg(errMsg);
++#endif
+ #else
+   appendToResultMsg(strerror(err));
+ #endif
+
-- 
1.9.5.msysgit.1

